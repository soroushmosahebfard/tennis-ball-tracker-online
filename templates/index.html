<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üéæ Hough-Circle Tennis-Ball Tracker</title>
  <style>
    body { background: #111; color: #fff; text-align: center; font-family: sans-serif; }
    #wrapper { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
    .feed { display: flex; flex-direction: column; align-items: center; }
    video, canvas { border: 4px solid #4caf50; }
    .feed p { margin: 6px 0; }
  </style>
</head>
<body>
  <h1>üîç Hough-Circle Tennis-Ball Tracker</h1>
  <div id="wrapper">
    <div class="feed">
      <p>Raw Feed</p>
      <video id="video" width="640" height="480" autoplay muted playsinline></video>
    </div>
    <div class="feed">
      <p>Detected</p>
      <canvas id="canvas" width="640" height="480"></canvas>
    </div>
  </div>

  <!-- Load OpenCV.js -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  <script>
    cv['onRuntimeInitialized'] = () => {
      const video  = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx    = canvas.getContext('2d');
      const w = 640, h = 480;

      // Mats
      const src   = new cv.Mat(h, w, cv.CV_8UC4);
      const gray  = new cv.Mat();
      const blur  = new cv.Mat();
      const circles = new cv.Mat();

      // Start camera
      navigator.mediaDevices.getUserMedia({video:true})
        .then(s => video.srcObject = s)
        .catch(e=>alert('Camera error:'+e.message));

      // Processing loop
      video.addEventListener('playing', () => {
        function process() {
          // grab frame
          ctx.drawImage(video, 0, 0, w, h);
          let imgData = ctx.getImageData(0,0,w,h);
          src.data.set(imgData.data);

          // to grayscale + blur
          cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
          cv.GaussianBlur(gray, blur, new cv.Size(9,9), 2);

          // HoughCircles params:
          // dp=1.2, minDist=100, param1=50, param2=30, minR=10, maxR=200
          cv.HoughCircles(blur, circles, cv.HOUGH_GRADIENT,
                          1.2, 100,
                          50, 30,
                          10, 200);

          // draw raw
          ctx.drawImage(video, 0, 0, w, h);
          // draw detected circle
          if (circles.rows > 0) {
            const c = circles.data32F;
            // pick the first circle
            const x = c[0], y = c[1], r = c[2];
            ctx.strokeStyle = '#FFFF00';
            ctx.lineWidth   = 4;
            ctx.beginPath();
            ctx.arc(x, y, r, 0, 2*Math.PI);
            ctx.stroke();
          }

          requestAnimationFrame(process);
        }
        requestAnimationFrame(process);
      });
    };
  </script>
</body>
</html>
